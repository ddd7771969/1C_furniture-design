&НаКлиенте
Перем мКомплектыДляАналогичногоДействия, ИзмененыСлужебныеНастройки, мТипыЗадачКонструктора;
&НаКлиенте
Перем ПутьКФайлуПДМ, СтруктураПроектноеВремяРазработкиВДнях, КомментарийУвеличеияПродолжительности;

&НаСервереБезКонтекста
Функция КонтрольСоответствияКонструкторов(ОбъектТЗ, КонструкторПользователь)

	Возврат омКонструктор.ПолучитьДанныеОбъекта(ОбъектТЗ, КонструкторПользователь).КонструкторПользователь;		

КонецФункции // КонтрольСоответствияКонструкторов()

&НаСервереБезКонтекста
Функция ПолучитьПроектноеВремяРазработки(ОбъектТЗ, Задача)

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДатыКомплекта.НормаВремени_ПКД КАК НормаВремени_ПКД,
		|	ДатыКомплекта.НормаДоработки_ПКД КАК НормаДоработки_ПКД,
		|	ЕСТЬNULL(ТаймингЗадачСрезПоследних.ТипЗадачи, ЗНАЧЕНИЕ(Перечисление.ТипыЗадачКонструирования.ПустаяСсылка)) КАК ТипЗадачи
		|ИЗ
		|	РегистрСведений.ДатыКомплекта КАК ДатыКомплекта
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТаймингЗадач.СрезПоследних КАК ТаймингЗадачСрезПоследних
		|		ПО ДатыКомплекта.Комплект = ТаймингЗадачСрезПоследних.Задача.ОбъектТЗ
		|ГДЕ
		|	ДатыКомплекта.Комплект = &Комплект
		|	И ТаймингЗадачСрезПоследних.Задача = &Задача";
	
	Запрос.УстановитьПараметр("Комплект", ОбъектТЗ);
	Запрос.УстановитьПараметр("Задача", Задача);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если Выборка.ТипЗадачи = Перечисления.ТипыЗадачКонструирования.ДоработкаКонструктором Тогда
		
			Возврат Новый Структура("Тип, Время", "Доработка", Выборка.НормаДоработки_ПКД);	
		
		Иначе
		
			Возврат Новый Структура("Тип, Время", "Разработка", Выборка.НормаВремени_ПКД);	
		
		КонецЕсли;	
	КонецЦикла;
	
	Возврат Новый Структура("Тип, Время", "Неопределено, 0");

КонецФункции // ПолучитьПроектноеВремяРазработки()

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	КомментарийУвеличеияПродолжительности = "";
	
	Если Параметры.Ключ.Пустая() Тогда
		Элементы.ДекорацияПроектноеВремя.Видимость = Ложь;	
	Иначе
		СтруктураПроектноеВремяРазработкиВДнях = ПолучитьПроектноеВремяРазработки(Объект.ОбъектТЗ, Объект.Ссылка);
		Если СтруктураПроектноеВремяРазработкиВДнях.Тип = "Неопределено" Тогда
			Элементы.ДекорацияПроектноеВремя.Видимость = Ложь;	
		Иначе
			Элементы.ДекорацияПроектноеВремя.Заголовок = СтруктураПроектноеВремяРазработкиВДнях.Тип + " " +
			СтруктураПроектноеВремяРазработкиВДнях.Время + " дней";
			
			Если СтруктураПроектноеВремяРазработкиВДнях.Тип = "Доработка" Тогда
				Элементы.ПланРазработкиВДнях.Заголовок = СтрЗаменить(Элементы.ПланРазработкиВДнях.Заголовок, "разработки", "доработки");
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;
	
	ПутьКФайлуПДМ = омФайлы.ПолучитьПутьКФайлуПДМ(Объект.ОбъектТЗ);
	
	мТипыЗадачКонструктора = омЗадачиПКДПовтор.ТипыЗадачКонструктора();
	
	ИзмененыСлужебныеНастройки = Ложь;
	
	мКомплектыДляАналогичногоДействия = Новый Массив;

	Если ПодчиненыеКомплекты.Количество() > 0 Тогда
		КомплектыДляАналогичногоДействия();	
	КонецЕсли;
	
	Элементы.ГруппаИстория.Видимость = Ложь;
	ВидимостьКнопок();
	
	стДополнительноеТЗ = ПроверитьДополнительноеТЗ(Объект.ОбъектТЗ);
	
	Элементы.ОписаниеДополнительногоТЗ.Заголовок 				= стДополнительноеТЗ.стрДополнениеТЗ;
	Элементы.КнопкаЗавершитьВыполнениеКонструктор.Доступность 	= стДополнительноеТЗ.МожноЗавершать;
	Элементы.ГруппаДополнениеТЗ.Видимость						= НЕ ПустаяСтрока(стДополнительноеТЗ.стрДополнениеТЗ);
	
	Если НЕ 
		(ТекущиеСостояние = ПредопределенноеЗначение("Перечисление.СостоянияЗадач.ПриостановкаКонструктором")
		ИЛИ ТекущиеСостояние = ПредопределенноеЗначение("Перечисление.СостоянияЗадач.ОтложенаКонструктором")
		ИЛИ ТекущиеСостояние = ПредопределенноеЗначение("Перечисление.СостоянияЗадач.ВРаботеКонструктора")
		ИЛИ ТекущиеСостояние = ПредопределенноеЗначение("Перечисление.СостоянияЗадач.ОжиданиеКонструктором")) Тогда
	
		Элементы.ПланРазработкиВДнях.Доступность = Ложь;	
		ПланРазработкиВДнях = ПолучитьПланРазработкиВДнях(Объект.Ссылка);
		
	КонецЕсли;
	
КонецПроцедуры 

Процедура УстановитьКартинкуПриоритета()

	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДанныеКомплектаСрезПоследних.Приоритет КАК Приоритет,
		|	ДанныеКомплектаСрезПоследних.Приоритет.СтатусПриоритета.МалаяКартинка КАК МалаяКартинка
		|ИЗ
		|	РегистрСведений.ДанныеКомплекта.СрезПоследних(, Комплект = &Комплект) КАК ДанныеКомплектаСрезПоследних";
	
	Запрос.УстановитьПараметр("Комплект", Объект.ОбъектТЗ);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Количество() = 0 Тогда
		Элементы.ГруппаПриоритет.Видимость = Ложь;
	Иначе
		
		Пока Выборка.Следующий() Цикл
			Если ЗначениеЗаполнено(Выборка.Приоритет) Тогда
			    Приоритет = Выборка.Приоритет;
				
				Попытка
				
					КартинкаПриоритета = ПоместитьВоВременноеХранилище(Выборка.МалаяКартинка.Получить(), 
												   УникальныйИдентификатор);

				
				Исключение
				
				КонецПопытки;
				
			
			Иначе
				Элементы.ГруппаПриоритет.Видимость = Ложь;
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	

КонецПроцедуры

Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Ключ.Пустая() Тогда 
		
		ТекущиеСостояние = Перечисления.СостоянияЗадач.ПустаяСсылка();
		Элементы.СтадияКомплекта.Видимость = Ложь;
		Элементы.ГруппаПриоритет.Видимость = Ложь;
		
	Иначе
		
		стДанные = РегистрыСведений.ТаймингЗадач.ПолучитьСостояниеЗадачи(Объект.Ссылка);
		ТекущиеСостояние 		= стДанные.Состояние;
		КрайПКД					= ПолучитьКрайПКД();

		Если Объект.Выполнена Тогда
			СтадияКомплекта = "Задача выполнена";
		Иначе
			СтадияКомплекта = омСтадииКомплекта.ПолучитьСтадиюКомплекта(Объект.ОбъектТЗ);
		КонецЕсли;
		
		УстановитьКартинкуПриоритета();
		
	КонецЕсли;
	
	Если Объект.Выполнена ИЛИ Объект.ТипЗадачи = Перечисления.ТипыЗадачКонструирования.Отмена Тогда
		
		ТолькоПросмотр 					= Истина;
		
		Элементы.ГруппаКнопкаКонструктора.Видимость 		= Ложь;	
		Элементы.ГруппаКнопкиВедущегоКонструктора.Видимость = Ложь;	
		Элементы.ГруппаКнопкиДизайнера.Видимость 			= Ложь;	
		Элементы.ГруппаФиндиректора.Видимость 				= Ложь;
		Элементы.ГруппаКнопкиМенеджера.Видимость 			= Ложь;	
	
	ИначеЕсли Объект.ТипЗадачи = Перечисления.ТипыЗадачКонструирования.Разработка 
		ИЛИ Объект.ТипЗадачи = Перечисления.ТипыЗадачКонструирования.ДоработкаКонструктором 
		ИЛИ Объект.ТипЗадачи = Перечисления.ТипыЗадачКонструирования.ИзменениеКонструктором Тогда
		
		Элементы.ГруппаКнопкаКонструктора.Видимость 		= Истина;	
		Элементы.ГруппаКнопкиВедущегоКонструктора.Видимость = Ложь;	
		Элементы.ГруппаКнопкиДизайнера.Видимость 			= Ложь;	
		Элементы.ГруппаКнопкиМенеджера.Видимость 			= Ложь;	
		Элементы.ГруппаФиндиректора.Видимость 				= Ложь;
		
	ИначеЕсли Объект.ТипЗадачи = Перечисления.ТипыЗадачКонструирования.ПодтверждениеВедущимКонструктором Тогда
		
		Элементы.ГруппаКнопкаКонструктора.Видимость 		= Ложь;	
		Элементы.ГруппаКнопкиВедущегоКонструктора.Видимость = Истина;	
		Элементы.ГруппаКнопкиДизайнера.Видимость 			= Ложь;	
		Элементы.ГруппаКнопкиМенеджера.Видимость 			= Ложь;	
		Элементы.ГруппаФиндиректора.Видимость 				= Ложь;
		
	ИначеЕсли Объект.ТипЗадачи = Перечисления.ТипыЗадачКонструирования.КонтрольДизайнера Тогда
		
		Элементы.ГруппаКнопкаКонструктора.Видимость 		= Ложь;	
		Элементы.ГруппаКнопкиВедущегоКонструктора.Видимость = Ложь;	
		Элементы.ГруппаКнопкиДизайнера.Видимость 			= Истина;	
		Элементы.ГруппаКнопкиМенеджера.Видимость 			= Ложь;	
		Элементы.ГруппаФиндиректора.Видимость 				= Ложь;
		
		Если Объект.СтатусЗадачи = Перечисления.СтатусыЗадач.Согласование Тогда
			
			Элементы.ДоработкаДизайнера.Видимость 			= Ложь;	
			Элементы.КорректировкаДизайнер.Видимость 		= Ложь;	
		
		Иначе
			
			Элементы.РекламацияДизайнер.Видимость 			= Ложь;	
			Элементы.РедакцияДизайнер.Видимость 			= Ложь;	
			Элементы.КонтрольКП.Видимость 					= Ложь;	
		
		КонецЕсли; 
		
		КоличествоЗадачЧекЛиста = Объект.ЧекЛист.Количество();
		Элементы.ГруппаЧекЛист.Видимость 	= КоличествоЗадачЧекЛиста > 0;
		Элементы.СоздатьЧекЛист.Видимость 	= НЕ Элементы.ГруппаЧекЛист.Видимость;

	ИначеЕсли Объект.ТипЗадачи = Перечисления.ТипыЗадачКонструирования.Согласование Тогда
		
		Элементы.ГруппаКнопкаКонструктора.Видимость 		= Ложь;	
		Элементы.ГруппаКнопкиВедущегоКонструктора.Видимость = Ложь;	
		Элементы.ГруппаКнопкиДизайнера.Видимость 			= Ложь;	
		Элементы.ГруппаКнопкиМенеджера.Видимость 			= Истина;
		Элементы.ГруппаФиндиректора.Видимость 				= Ложь;
		
		Если Объект.СтатусЗадачи = Перечисления.СтатусыЗадач.Согласование Тогда
			Элементы.ВозвратСЗапроса.Видимость 		= Ложь;	
		Иначе
		
			Элементы.СогласованоМенеджер.Видимость 	= Ложь;	
			Элементы.ВозвратССогласования.Видимость = Ложь;	
		
		КонецЕсли;
		
		
	ИначеЕсли Объект.ТипЗадачи = Перечисления.ТипыЗадачКонструирования.ОжиданиеФиндиректором Тогда
		
		Элементы.ГруппаКнопкаКонструктора.Видимость 		= Ложь;	
		Элементы.ГруппаКнопкиВедущегоКонструктора.Видимость = Ложь;	
		Элементы.ГруппаКнопкиДизайнера.Видимость 			= Ложь;	
		Элементы.ГруппаКнопкиМенеджера.Видимость 			= Ложь;
		Элементы.ГруппаФиндиректора.Видимость 				= Истина;
		
	ИначеЕсли Объект.ТипЗадачи = Перечисления.ТипыЗадачКонструирования.ОжиданиеМенеджером Тогда
		
		Элементы.ГруппаКнопкаКонструктора.Видимость 		= Ложь;	
		Элементы.ГруппаКнопкиВедущегоКонструктора.Видимость = Ложь;	
		Элементы.ГруппаКнопкиДизайнера.Видимость 			= Ложь;	
		Элементы.ГруппаКнопкиМенеджера.Видимость 			= Истина;
		Элементы.ГруппаФиндиректора.Видимость 				= Ложь;
		
		Если Объект.СтатусЗадачи = Перечисления.СтатусыЗадач.Согласование Тогда
			Элементы.ВозвратСЗапроса.Видимость 		= Ложь;	
		Иначе
		
			Элементы.СогласованоМенеджер.Видимость 	= Ложь;	
			Элементы.ВозвратССогласования.Видимость = Ложь;	
		
		КонецЕсли;

		Элементы.ГруппаЧекЛист.Видимость 	= Объект.ЧекЛист.Количество() > 0;

	КонецЕсли;
	
	Элементы.ОбновитьИсполнителя.Видимость = Элементы.ГруппаКнопкаКонструктора.Видимость;
	
	Если ТипЗнч(Объект.ОбъектТЗ) = Тип("СправочникСсылка.Композиции") Тогда
		
		ЗаполнитьПодчиненыеКомплекты();
		Элементы.Композиция.Видимость = Ложь;	
		Элементы.ОбъектТЗ.Заголовок = "Композиция";
		
	Иначе
		
		Элементы.ПодчиненыеКомплекты.Видимость = Ложь;	
		Элементы.ОбъектТЗ.Заголовок = "Комплект";
		
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.Композиция) Тогда      
	
		Элементы.Композиция.Видимость = Ложь;	
	
	КонецЕсли;
	
	Элементы.ГруппаСлужебная.Видимость = РольДоступна("ПолныеПрава");
	Состояние = ТекущиеСостояние;
	
	ДокОбъект = РеквизитФормыВЗначение("Объект");
	
	мТипыЗадачДяКонструктора = омЗадачиПКДПовтор.ТипыЗадачКонструктора();
	Если НЕ мТипыЗадачДяКонструктора.Найти(Объект.ТипЗадачи) = Неопределено Тогда
		
		Элементы.Исполнитель.ТолькоПросмотр = Истина;	
		
	КонецЕсли;
	
КонецПроцедуры 

&НаСервереБезКонтекста
Функция ПолучитьПланРазработкиВДнях(Ссылка)

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПлановоеЗначениеПроектированияСрезПоследних.ПланРазработкиВДнях КАК ПланРазработкиВДнях
		|ИЗ
		|	РегистрСведений.ПлановоеЗначениеПроектирования.СрезПоследних(, Задача = &Задача) КАК ПлановоеЗначениеПроектированияСрезПоследних";
	
	Запрос.УстановитьПараметр("Задача", Ссылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Возврат Выборка.ПланРазработкиВДнях;
	КонецЦикла;
	
	Возврат 0;

КонецФункции // ПолучитьПланРазработкиВДнях()

&НаСервереБезКонтекста
Функция ПроверитьДополнительноеТЗ(Ссылка)

	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СУММА(ВЫБОР
		|			КОГДА Дополнение_к_ТЗ.ЕстьФайл
		|				ТОГДА 1
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК ФайлТЗ,
		|	СУММА(ВЫБОР
		|			КОГДА Дополнение_к_ТЗ.ДатаОзнакомления = ДАТАВРЕМЯ(1, 1, 1)
		|				ТОГДА 0
		|			ИНАЧЕ 1
		|		КОНЕЦ) КАК Ознакомлено,
		|	КОЛИЧЕСТВО(Дополнение_к_ТЗ.Комплект) КАК Комплект
		|ИЗ
		|	РегистрСведений.Дополнение_к_ТЗ КАК Дополнение_к_ТЗ
		|ГДЕ
		|	Дополнение_к_ТЗ.Комплект = &Комплект";
	
	Запрос.УстановитьПараметр("Комплект", Ссылка);
	Выборка = Запрос.Выполнить().Выбрать();
	
	стрДополнениеТЗ = "";
	МожноЗавершать 	= Истина;
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Комплект > 0 Тогда
			
			стрДополнениеТЗ = СтрШаблон("Всего изменений %1. Ознакомлено %2. С файлами %3"
			, Выборка.Комплект, Выборка.Ознакомлено, Выборка.ФайлТЗ); 
			
			МожноЗавершать = Выборка.Комплект = Выборка.Ознакомлено;
			
		КонецЕсли;
	КонецЦикла;
	
    Возврат Новый Структура("МожноЗавершать, стрДополнениеТЗ", МожноЗавершать, стрДополнениеТЗ)

КонецФункции

#Область Команды

&НаКлиенте
Процедура История(Команда)
	
	История = ДействияНаСервере("История", Новый Массив,Объект.Ссылка, Объект.ТипЗадачи);
	Элементы.ГруппаИстория.Видимость = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗакрытьИсторию(Команда)
	Элементы.ГруппаИстория.Видимость = Ложь;
КонецПроцедуры

#Область  КомандыКонструктора

&НаКлиенте
Процедура НачатьВыполнение(Команда)
	
	Если ПланРазработкиВДнях = 0 Тогда
	
		ПоказатьПредупреждение(, "Не заполнен План разработки в днях");
		Возврат;
	
	КонецЕсли;
	
	
	
	ЗаписатьПланРазработкиВДняхНаСервере(Объект.Ссылка, ПланРазработкиВДнях, КомментарийУвеличеияПродолжительности);


	КонструкторОбъекта = КонтрольСоответствияКонструкторов(Объект.ОбъектТЗ, Объект.Исполнитель);
	
	Если НЕ КонструкторОбъекта = Объект.Исполнитель Тогда
		
		ПоказатьПредупреждение(, "Конструктор в объекте " + КонструкторОбъекта + " не соответствует исполнителю");
		Возврат;
		
	КонецЕсли;
	
	стДанные = ДействияНаСервере("НачатьВыполнение", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.СтатусЗадачи);
	
	стВозврата = омВыгрузкаCRMНаКлиенте.ВыгрузитьВPDM(Объект.Ссылка, "РаздатьПрава");
	
	Если ПустаяСтрока(стВозврата.ОписаниеОшибки) Тогда
		
		Закрыть();
		
	Иначе
		
		ПоказатьПредупреждение(,стВозврата.ОписаниеОшибки);
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьВыполнение(Команда)
	
	Если Модифицированность Тогда
		
		ПоказатьПредупреждение(, "Не обходимо сохранить задачу.");
		Возврат;
		
	КонецЕсли;
	
	стДанные = ДействияНаСервере("ЗавершениеРаботы", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	
	стВозврата = омВыгрузкаCRMНаКлиенте.ВыгрузитьВPDM(Объект.Ссылка, "ЗабратьПрава");
	
	Если НЕ ПустаяСтрока(стВозврата.ОписаниеОшибки) Тогда
		
		ПоказатьПредупреждение(,стВозврата.ОписаниеОшибки);
		
	КонецЕсли;
	
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура Отложить(Команда)
	// Вставить содержимое обработчика.
КонецПроцедуры

&НаКлиенте
Процедура Приостановить(Команда)
	
	стДанные = ДействияНаСервере("Приостановить", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель);
	Закрыть();
	
КонецПроцедуры
#КонецОбласти

#Область КомандыВедущегоКонструктороа

&НаКлиенте
Процедура ИзменениеВедущийКонструктор(Команда)
	
	стДанные = ДействияНаСервере("ИзменениеВедущийКонструктор", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель);
	Закрыть();
	
КонецПроцедуры

&НаКлиенте
Процедура ДоработкаВедущийКонструктор(Команда)
	
	стДанные = ДействияНаСервере("ДоработкаВедущийКонструктор", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель);
	Закрыть();
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрольВедущийКонструктор(Команда)
	
	стДанные = ДействияНаСервере("КонтрольВедущийКонструктор", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
	
КонецПроцедуры

#КонецОбласти


#Область КомандыМенеджер

&НаКлиенте
Процедура ВозвратССогласования(Команда)
	Если Модифицированность Тогда
		Записать();
	КонецЕсли;
	
	стДанные = ДействияНаСервере("ВозвратССогласования", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура СогласованоМенеджер(Команда)
	стДанные = ДействияНаСервере("Согласовано", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура ВозвратСЗапроса(Команда)
	
	Если Модифицированность Тогда
		Записать();
	КонецЕсли;
	
	стДанные = ДействияНаСервере("ВозвратСЗапроса", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
	
КонецПроцедуры

#КонецОбласти

#Область КомандыДизайнера

&НаКлиенте
Процедура СоздатьЧекЛист(Команда)
	Элементы.ГруппаЧекЛист.Видимость = Истина;
КонецПроцедуры

&НаКлиенте
Процедура РекламацияДизайнер(Команда)

	стДанные = ДействияНаСервере("РекламацияДизайнер", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
	
КонецПроцедуры

&НаКлиенте
Процедура РедакцияДизайнер(Команда)

	стДанные = ДействияНаСервере("РедакцияДизайнер", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
	
КонецПроцедуры


&НаКлиенте
Процедура ДоработкаДизайнера(Команда)
	
	стДанные = ДействияНаСервере("ДоработкаДизайнера", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
	
КонецПроцедуры

&НаКлиенте
Процедура КорректировкаДизайнер(Команда)
	
	стДанные = ДействияНаСервере("КорректировкаДизайнер", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
	
КонецПроцедуры

&НаКлиенте
Процедура Согласовано(Команда)
	стДанные = ДействияНаСервере("Согласовано", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура ВнешнееСоглосование(Команда) 
	
	стПараметры = Новый Структура("Задача, Объект, Исполнитель, ТипДействия, мКомплектыДляАналогичногоДействия"
	, Объект.Ссылка, Объект.ОбъектТЗ, Объект.Исполнитель, ПредопределенноеЗначение("Перечисление.СостоянияЗадач.ВнешнееСогласование"), мКомплектыДляАналогичногоДействия);
	ОткрытьФорму("Задача.Задачи_ПКД.Форма.ФормаДатаКомментарий", стПараметры, ЭтаФорма,,,,,РежимОткрытияОкнаФормы.БлокироватьВесьИнтерфейс);
	
КонецПроцедуры

&НаКлиенте
Процедура ВнешнийЗапрос(Команда)
	
	Если Модифицированность Тогда
		Записать();
	КонецЕсли;
	
	стПараметры = Новый Структура("Задача, Объект, Исполнитель, ТипДействия, мКомплектыДляАналогичногоДействия", Объект.Ссылка, Объект.ОбъектТЗ, Объект.Исполнитель, ПредопределенноеЗначение("Перечисление.СостоянияЗадач.ВнешнийЗапрос"), мКомплектыДляАналогичногоДействия);
	ОткрытьФорму("Задача.Задачи_ПКД.Форма.ФормаДатаКомментарий", стПараметры, ЭтаФорма,,,,,РежимОткрытияОкнаФормы.БлокироватьВесьИнтерфейс);
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрольКП(Команда)
	
	стДанные = ДействияНаСервере("КонтрольКП", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
	
КонецПроцедуры

#КонецОбласти 

#Область ФинДиректор

&НаКлиенте
Процедура СогласованоСИзменением(Команда)
	стДанные = ДействияНаСервере("СогласованоСИзменением", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура СогласованоБезИзменений(Команда)
	стДанные = ДействияНаСервере("СогласованоБезИзменений", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура ОтменаИзделия(Команда)
	стДанные = ДействияНаСервере("ОтменаИзделия", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.ОбъектТЗ);
	Закрыть();
КонецПроцедуры

#КонецОбласти 

&НаКлиенте
Процедура ОткрытьФайлПДМ(Команда)
	
	Если ПустаяСтрока(ПутьКФайлуПДМ) Тогда
		ПоказатьПредупреждение(, "Не удалось построить путь к файлу");
	Иначе
		
		Файл = Новый Файл(ПутьКФайлуПДМ);
		
		Если Файл.Существует() Тогда
			ФайловаяСистемаКлиент.ОткрытьПроводник(ПутьКФайлуПДМ);
		Иначе
			ПоказатьПредупреждение(, "Не существует файла " + ПутьКФайлуПДМ);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры


#КонецОбласти

&НаКлиенте
Процедура КомплектыДляАналогичногоДействия()

	Если ТипЗнч(Объект.ОбъектТЗ) = Тип("СправочникСсылка.Композиции") Тогда
		КонструкторКомпозиции = омКомпозицииСервер.ПолучитьДанныеКомпозиции(Объект.ОбъектТЗ);	
	Иначе
		Возврат;
	КонецЕсли; 
	
	НЕЗадачаКонструктора = мТипыЗадачКонструктора.Найти(Объект.ТипЗадачи) = Неопределено;
	
	Для каждого СтрокаТаблицы Из ПодчиненыеКомплекты Цикл
		
		Если СтрокаТаблицы.Конструктор = КонструкторКомпозиции ИЛИ НЕЗадачаКонструктора Тогда
			мКомплектыДляАналогичногоДействия.Добавить(СтрокаТаблицы.Комплект);	
		КонецЕсли;
		
	КонецЦикла;

КонецПроцедуры // КомплектыДляАналогичногоДайствия()

&НаСервереБезКонтекста
Функция ДействияНаСервере(Действие, Знач мКомплектыДляАналогичногоДействия, Задача, ТипЗадачи, Исполнитель = Неопределено, Параметр = Неопределено)

	Возврат Задачи.Задачи_ПКД.ДействияНаСервере(Действие, мКомплектыДляАналогичногоДействия, Задача, ТипЗадачи, Исполнитель, Параметр);	

КонецФункции // ДействияНаСервере("НачатьВыполнение", мКомплектыДляАналогичногоДействия, Объект.Ссылка, Объект.ТипЗадачи, Объект.Исполнитель, Объект.СтатусЗадачи)()

Функция ПолучитьКрайПКД()

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДатыКомплекта.КрайПКД КАК КрайПКД
		|ИЗ
		|	РегистрСведений.ДатыКомплекта КАК ДатыКомплекта
		|ГДЕ
		|	ДатыКомплекта.Комплект = &Комплект";
	
	Запрос.УстановитьПараметр("Комплект", Объект.ОбъектТЗ);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Возврат Выборка.КрайПКД; 
	КонецЦикла; 
	
	Возврат Дата(1, 1, 1);
	
КонецФункции // ПолучитьКрайПКД()

&НаКлиенте
Процедура ВидимостьКнопок()
	
	Если ТекущиеСостояние = ПредопределенноеЗначение("Перечисление.СостоянияЗадач.ЗавершенаКонструктором") Тогда
		
		Элементы.КнопкаНачатьВыполнениеКонструктор.Видимость 		= Ложь;
		Элементы.КнопкаЗавершитьВыполнениеКонструктор.Видимость 	= Ложь;
		Элементы.КнопкаОтложитьКонструктор.Видимость 				= Ложь;
		Элементы.КнопкаПриостановитьКонструктор.Видимость 			= Ложь;
		
	ИначеЕсли ТекущиеСостояние = ПредопределенноеЗначение("Перечисление.СостоянияЗадач.ВРаботеКонструктора") Тогда
		
		Элементы.КнопкаНачатьВыполнениеКонструктор.Видимость 		= Ложь;
		Элементы.КнопкаЗавершитьВыполнениеКонструктор.Видимость 	= Истина;
		Элементы.КнопкаПриостановитьКонструктор.Видимость 			= Истина;
		//Элементы.КнопкаОтложитьКонструктор.Видимость 				= Истина;
		
	ИначеЕсли ТекущиеСостояние = ПредопределенноеЗначение("Перечисление.СостоянияЗадач.ОжиданиеКонструктором") Тогда
		
		Элементы.КнопкаЗавершитьВыполнениеКонструктор.Видимость 	= Ложь;
		Элементы.КнопкаНачатьВыполнениеКонструктор.Видимость 		= Истина;
		Элементы.КнопкаПриостановитьКонструктор.Видимость 			= Ложь;
		Элементы.КнопкаОтложитьКонструктор.Видимость 				= Ложь;
		
	ИначеЕсли ТекущиеСостояние = ПредопределенноеЗначение("Перечисление.СостоянияЗадач.ПриостановкаКонструктором") Тогда
		
		Элементы.КнопкаНачатьВыполнениеКонструктор.Видимость 		= Истина;
		Элементы.КнопкаЗавершитьВыполнениеКонструктор.Видимость 	= Ложь;
		Элементы.КнопкаПриостановитьКонструктор.Видимость 			= Ложь;
		Элементы.КнопкаОтложитьКонструктор.Видимость 				= Ложь;
		
	Иначе
		
		Элементы.КнопкаЗавершитьВыполнениеКонструктор.Видимость 	= Ложь;
		Элементы.КнопкаОтложитьКонструктор.Видимость 				= Ложь;
		Элементы.КнопкаПриостановитьКонструктор.Видимость 			= Ложь;
		
	КонецЕсли;
	
	Элементы.ИзменениеВедущийКонструктор.Видимость 					= Объект.ДополнительноеСвойство = "Добавление комплекта"; //Был добавлен комплект в композицию
	Элементы.ДоработкаВедущийКонструктор.Видимость                  = НЕ Элементы.ИзменениеВедущийКонструктор.Видимость;
	
КонецПроцедуры // ВидимостьКнопок()

&НаКлиенте
Процедура ЗаписатьЗадачу(Команда)
	Записать();
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	Оповестить("ИзменениеПКД", Объект.ОбъектТЗ);
	омВыгрузкаCRMНаСевере.УстановитьСчетчикПоискаФайлаОтветаВыгрузкиPDM(0);
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	Если ИмяСобытия = "ИзменениеПКД" И Открыта() И Параметр = Объект.ОбъектТЗ Тогда
		Закрыть();
	ИначеЕсли ИмяСобытия = "ИзделиеКомплектИзменено" И Параметр = Объект.ОбъектТЗ Тогда
		ТекущаяМодифицированость 	= Модифицированность;
		Объект.Исполнитель 			= ПроверитьКонструктораНаСервере(Объект.Ссылка);
		Модифицированность			= ТекущаяМодифицированость;	
	КонецЕсли;
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПроверитьКонструктораНаСервере(Ссылка)

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Задачи_ПКД.Исполнитель КАК Исполнитель
		|ИЗ
		|	Задача.Задачи_ПКД КАК Задачи_ПКД
		|ГДЕ
		|	Задачи_ПКД.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Возврат Выборка.Исполнитель;
	КонецЦикла;
	

КонецФункции		

&НаКлиенте
Процедура ПодчиненыеКомплектыПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ПодчиненыеКомплектыПередУдалением(Элемент, Отказ)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ПодчиненыеКомплектыПередНачаломИзменения(Элемент, Отказ)
	Отказ = Истина;
	
	ТД = Элементы.ПодчиненыеКомплекты.ТекущиеДанные;
	
	Если ТД = Неопределено Тогда
		Возврат;	
	КонецЕсли;
	
	ПоказатьЗначение(, ТД.Задача);
	
КонецПроцедуры

Процедура ЗаполнитьПодчиненыеКомплекты()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Задачи_ПКД.ТипЗадачи КАК ТипЗадачи,
		|	Задачи_ПКД.Ссылка КАК Задача,
		|	Задачи_ПКД.Исполнитель КАК Исполнитель,
		|	Задачи_ПКД.ОбъектТЗ КАК Комплект,
		|	ТаймингЗадачСрезПоследних.Состояние КАК СостояниеЗадачи,
		|	ДанныеКомплектаСрезПоследних.Конструктор КАК Конструктор,
		|	Задачи_ПКД.ОбобщеннаяЗадача КАК ОбобщеннаяЗадача
		|ИЗ
		|	Задача.Задачи_ПКД КАК Задачи_ПКД
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТаймингЗадач.СрезПоследних КАК ТаймингЗадачСрезПоследних
		|		ПО Задачи_ПКД.Ссылка = ТаймингЗадачСрезПоследних.Задача
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеКомплекта.СрезПоследних КАК ДанныеКомплектаСрезПоследних
		|		ПО Задачи_ПКД.ОбъектТЗ = ДанныеКомплектаСрезПоследних.Комплект
		|ГДЕ
		|	Задачи_ПКД.Композиция = &Композиция
		|	И ТИПЗНАЧЕНИЯ(Задачи_ПКД.ОбъектТЗ) = ТИП(Справочник.ИзделияКомплект)";
	
	Запрос.УстановитьПараметр("Композиция", Объект.ОбъектТЗ);
	
	ПодчиненыеКомплекты.Загрузить(Запрос.Выполнить().Выгрузить());
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьПодчиненыеКомплекты(Команда)
	ЗаполнитьПодчиненыеКомплекты();
КонецПроцедуры

&НаКлиенте
Процедура ТипЗадачиПриИзменении(Элемент)
	ИзмененыСлужебныеНастройки = Истина;
КонецПроцедуры

&НаКлиенте
Процедура СтатусЗадачиПриИзменении(Элемент)
	ИзмененыСлужебныеНастройки = Истина;
КонецПроцедуры

&НаКлиенте
Процедура СостояниеПриИзменении(Элемент)
	ИзмененыСлужебныеНастройки = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	Если ИзмененыСлужебныеНастройки Тогда
		
		ИзменитьСостоянияНаСервере(Объект.Ссылка, Объект.ОбъектТЗ, Объект.ТипЗадачи, Объект.СтатусЗадачи, Состояние);		
	КонецЕсли;
	омЗадачиПКДСервер.УстановитьСтадиюКомплекта(Объект.Ссылка);
	
	Если ПланРазработкиВДнях > 0 Тогда
	
		ЗаписатьПланРазработкиВДняхНаСервере(Объект.Ссылка, ПланРазработкиВДнях, КомментарийУвеличеияПродолжительности);
	
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗаписатьПланРазработкиВДняхНаСервере(Задача, ПланРазработкиВДнях, КомментарийУвеличеияПродолжительности)

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	*
		|ИЗ
		|	РегистрСведений.ПлановоеЗначениеПроектирования.СрезПоследних(, Задача = &Задача) КАК ПлановоеЗначениеПроектированияСрезПоследних";
	
	Запрос.УстановитьПараметр("Задача", Задача);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	МенеджерЗаписи = РегистрыСведений.ПлановоеЗначениеПроектирования.СоздатьМенеджерЗаписи();
	
	Пока Выборка.Следующий() Цикл
		ЗаполнитьЗначенияСвойств(МенеджерЗаписи, Выборка);	
	КонецЦикла;
	
	МенеджерЗаписи.Период 				= ТекущаяДата();
	МенеджерЗаписи.Задача 				= Задача;
	МенеджерЗаписи.Автор				= ПараметрыСеанса.ТекущийПользователь;
	МенеджерЗаписи.ПланРазработкиВДнях 	= ПланРазработкиВДнях;
	МенеджерЗаписи.Комментарий 			= КомментарийУвеличеияПродолжительности;
	
	МенеджерЗаписи.Записать();
	
КонецПроцедуры


&НаСервереБезКонтекста
Процедура ИзменитьСостоянияНаСервере(Задача, ОбъектТЗ, ТипЗадачи, СтатусЗадачи, Состояние)
	
	Исполнитель = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТаймингЗадачСрезПоследних.Исполнитель КАК Исполнитель
		|ИЗ
		|	РегистрСведений.ТаймингЗадач.СрезПоследних(, Задача = &Задача) КАК ТаймингЗадачСрезПоследних";
	
	Запрос.УстановитьПараметр("Задача", Задача);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Исполнитель = Выборка.Исполнитель			
	КонецЦикла;
	
	МЗ = РегистрыСведений.ТаймингЗадач.СоздатьМенеджерЗаписи();
	МЗ.Период =  ТекущаяДата();
	МЗ.Автор = ПараметрыСеанса.ТекущийПользователь;
	МЗ.Задача = Задача;
	МЗ.Исполнитель = Исполнитель;
	МЗ.Состояние = Состояние;
	МЗ.Статус = СтатусЗадачи;
	МЗ.ТипЗадачи = ТипЗадачи;
	
	МЗ.Записать();
	
	
КонецПроцедуры // ИзменитьСостоянияНаСервере()

 &НаСервереБезКонтекста
Процедура СнятьСВыполненияНаСервере(Ссылка)
	Об = Ссылка.ПолучитьОбъект();
	об.Выполнена = Ложь;
	Об.Записать();
КонецПроцедуры

&НаКлиенте
Процедура СнятьСВыполнения(Команда)
	СнятьСВыполненияНаСервере(Объект.Ссылка);
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура ЧекЛистПередНачаломИзменения(Элемент, Отказ)
	ТД = Элементы.ЧекЛист.ТекущиеДанные;
	
	Если ТД = Неопределено Тогда
	
		Возврат;	
	
	КонецЕсли;
	
	Если ТД.Выполнение Тогда
	
		Отказ = Истина;
		Возврат;
	
	КонецЕсли;
	
	
КонецПроцедуры

&НаКлиенте
Процедура ЧекЛистПриИзменении(Элемент)
	
	ПустаяДата = Дата(1, 1, 1);
	
	Для каждого х Из Объект.ЧекЛист Цикл
	
		Если х.Выполнение И х.ДатаВыполнения = ПустаяДата Тогда
		
			х.ДатаВыполнения 	= ТекущаяДата();	
			х.АвторВыполнения 	= омСотрудники.ПолучитьТекущегоПользователя();	
		
		КонецЕсли;	
	
	КонецЦикла;
	
КонецПроцедуры


&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	ТекущийОбъект.Наименование = Задачи.Задачи_ПКД.ПолучитьЗаголовокЗадачи(ТекущийОбъект.ОбъектТЗ);
КонецПроцедуры


&НаКлиенте
Процедура ОткрытьДополнениеТЗ(Команда)
	
	ОповещениеПослеЗакрытия = Новый ОписаниеОповещения("ПослеПрочтенияДополнения", ЭтаФорма);
	ОткрытьФорму("Задача.Задачи_ПКД.Форма.ФормаДополнетельноеТЗ", Новый Структура("Комплект", Объект.ОбъектТЗ), ЭтаФорма, , , , ОповещениеПослеЗакрытия, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);

КонецПроцедуры


&НаКлиенте
Процедура ПослеПрочтенияДополнения(Результат, ДополнительныеПараметры) Экспорт

	стДополнительноеТЗ = ПроверитьДополнительноеТЗ(Объект.ОбъектТЗ);
	
	Элементы.ОписаниеДополнительногоТЗ.Заголовок 				= стДополнительноеТЗ.стрДополнениеТЗ;
	Элементы.КнопкаЗавершитьВыполнениеКонструктор.Доступность 	= стДополнительноеТЗ.МожноЗавершать;
	
КонецПроцедуры // ПослеПрочтенияДополнения()


&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	//Вставить содержимое обработчика
КонецПроцедуры


&НаКлиенте
Процедура ПланРазработкиВДняхПриИзменении(Элемент)
	Если СтруктураПроектноеВремяРазработкиВДнях.Время > 0 
		И СтруктураПроектноеВремяРазработкиВДнях.Время < ПланРазработкиВДнях
		И ПустаяСтрока(КомментарийУвеличеияПродолжительности) Тогда
		
		Подсказка = "Введите причину увеличения срока";
		Оповещение = Новый ОписаниеОповещения("ПослеВводаКомментарияУвеличенияСрока", ЭтаФорма);
		ПоказатьВводСтроки(Оповещение, "", Подсказка, 0, Истина);
		
	Иначе 
		
		КомментарийУвеличеияПродолжительности = "";	
		
	КонецЕсли;
	
	Элементы.ДекорацияДатаОкончания.Видимость = Истина;
	Элементы.ДекорацияДатаОкончания.Заголовок = "Дата окончания " + Формат(ТекущаяДата() + ПланРазработкиВДнях * 24 * 3600, "ДЛФ=DD");

КонецПроцедуры  

&НаКлиенте
Процедура ПослеВводаКомментарияУвеличенияСрока(Строка, Параметры) Экспорт
	Если НЕ Строка = Неопределено Тогда
		КомментарийУвеличеияПродолжительности = Строка;
    КонецЕсли;
КонецПроцедуры


&НаСервереБезКонтекста
Функция ОбновитьИсполнителяНаСервере(ОбъектТЗ)

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Пользователи.Ссылка КАК Конструктор
		|ИЗ
		|	РегистрСведений.ДанныеКомплекта.СрезПоследних КАК ДанныеКомплектаСрезПоследних
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Пользователи КАК Пользователи
		|		ПО ДанныеКомплектаСрезПоследних.Конструктор = Пользователи.Сотрудник
		|ГДЕ
		|	ДанныеКомплектаСрезПоследних.Комплект = &Комплект";
	
	Запрос.УстановитьПараметр("Комплект", ОбъектТЗ);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Возврат Выборка.Конструктор;
	КонецЦикла;
	
КонецФункции


&НаКлиенте
Процедура ОбновитьИсполнителя(Команда)
	Объект.Исполнитель = ОбновитьИсполнителяНаСервере(Объект.ОбъектТЗ);
КонецПроцедуры

