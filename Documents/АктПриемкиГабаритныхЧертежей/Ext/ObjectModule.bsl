
Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)

	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ВыездНаЗамер") Тогда
		// Заполнение шапки
		Автор 		= ПараметрыСеанса.ТекущийПользователь;
		Проект 		= ДанныеЗаполнения.Проект;
		Основание 	= ДанныеЗаполнения.Ссылка;
		
		Для Каждого ТекСтрокаГабаритныеЧерчежи Из ДанныеЗаполнения.ГабаритныеЧертежи Цикл
			Если ТекСтрокаГабаритныеЧерчежи.ЗамерПроизведен Тогда
				
				НоваяСтрока 					= ГабаритныеЧертежи.Добавить();
				НоваяСтрока.ГабаритныйЧертеж 	= ТекСтрокаГабаритныеЧерчежи.ГабаритныйЧертеж;
				НоваяСтрока.Комментарий 		= ТекСтрокаГабаритныеЧерчежи.Комментарий;
				
			КонецЕсли;
		КонецЦикла; 
		
	КонецЕсли;
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	ПолучитьГЧДляИзменения();
КонецПроцедуры

Функция ПолучитьГЧДляИзменения()
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ГабаритныеЧертежиТЧ.ГабаритныйЧертеж КАК ГабаритныйЧертеж
		|ПОМЕСТИТЬ ГабаритныеЧертежиТЧ
		|ИЗ
		|	&ГабаритныеЧертежиТЧ КАК ГабаритныеЧертежиТЧ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ГабаритныеЧертежиТЧ.ГабаритныйЧертеж КАК ГабаритныйЧертеж
		|ПОМЕСТИТЬ НЕСозданныеЗадачиПоГЧ
		|ИЗ
		|	ГабаритныеЧертежиТЧ КАК ГабаритныеЧертежиТЧ
		|		ЛЕВОЕ СОЕДИНЕНИЕ Задача.ПроверитьГабаритныеЧертежи КАК ПроверитьГабаритныеЧертежи
		|		ПО ГабаритныеЧертежиТЧ.ГабаритныйЧертеж = ПроверитьГабаритныеЧертежи.ГабаритныйЧертеж
		|			И (ПроверитьГабаритныеЧертежи.Основание = &Ссылка)
		|ГДЕ
		|	ПроверитьГабаритныеЧертежи.Ссылка ЕСТЬ NULL
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	НЕСозданныеЗадачиПоГЧ.ГабаритныйЧертеж КАК ГабаритныйЧертеж
		|ПОМЕСТИТЬ втГЧ
		|ИЗ
		|	НЕСозданныеЗадачиПоГЧ КАК НЕСозданныеЗадачиПоГЧ
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.АктПриемкиГабаритныхЧертежей.ГабаритныеЧертежи КАК АктПриемкиГабаритныхЧертежейГабаритныеЧертежи
		|		ПО (АктПриемкиГабаритныхЧертежейГабаритныеЧертежи.ГабаритныйЧертеж = НЕСозданныеЗадачиПоГЧ.ГабаритныйЧертеж)
		|			И (АктПриемкиГабаритныхЧертежейГабаритныеЧертежи.Ссылка.Проведен)
		|			И (АктПриемкиГабаритныхЧертежейГабаритныеЧертежи.Ссылка.Дата > &Дата)
		|ГДЕ
		|	АктПриемкиГабаритныхЧертежейГабаритныеЧертежи.ГабаритныйЧертеж ЕСТЬ NULL
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втГЧ.ГабаритныйЧертеж КАК ГабаритныйЧертеж,
		|	ЕСТЬNULL(СостояниеЗамераСрезПоследних.СтатусЗамера, ЗНАЧЕНИЕ(Перечисление.СтатусыЗамера.ПустаяСсылка)) КАК Статус
		|ПОМЕСТИТЬ втГЧССотоянием
		|ИЗ
		|	втГЧ КАК втГЧ
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СостояниеЗамера.СрезПоследних(&Дата, ОбъектЗамера В (&ГабаритныйЧертеж)) КАК СостояниеЗамераСрезПоследних
		|		ПО втГЧ.ГабаритныйЧертеж = СостояниеЗамераСрезПоследних.ОбъектЗамера
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втГЧССотоянием.ГабаритныйЧертеж КАК ГабаритныйЧертеж,
		|	втГЧССотоянием.ГабаритныйЧертеж.Наименование КАК ГабаритныйЧертежНаименование,
		|	втГЧССотоянием.ГабаритныйЧертеж.Проект КАК Проект
		|ИЗ
		|	втГЧССотоянием КАК втГЧССотоянием
		|ГДЕ
		|	втГЧССотоянием.Статус <> &СтатусЗамера
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	НазначениеАвтораДляЗадачи.Исполнитель КАК Исполнитель
		|ИЗ
		|	Справочник.НазначениеАвтораДляЗадачи КАК НазначениеАвтораДляЗадачи
		|ГДЕ
		|	НазначениеАвтораДляЗадачи.ОбъектЗадачи = ЗНАЧЕНИЕ(Перечисление.ОбъектыЗадач.ПроверятьГабаритныеЧерчежи)";
	
	Запрос.УстановитьПараметр("ГабаритныеЧертежиТЧ", 	ГабаритныеЧертежи.Выгрузить(, "ГабаритныйЧертеж"));
	Запрос.УстановитьПараметр("ГабаритныйЧертеж", 		ГабаритныеЧертежи.ВыгрузитьКолонку("ГабаритныйЧертеж"));
	Запрос.УстановитьПараметр("Дата", 					Дата);
	Запрос.УстановитьПараметр("СтатусЗамера", 			НовыйСтатус);
	Запрос.УстановитьПараметр("Ссылка", 				Ссылка);
	
	Результат = Запрос.ВыполнитьПакет(); 
	
	Исполнитель = Неопределено;
	Выборка = Результат[5].Выбрать();
	Пока Выборка.Следующий() Цикл
		Исполнитель = Выборка.Исполнитель;
	КонецЦикла;
	
	
	//Выборка = Результат[4].Выбрать();                   
	//Пока Выборка.Следующий() Цикл
	//	СоздатьЗадачуПроверитьГабаритныеЧертежи(Выборка, Исполнитель);
	//КонецЦикла;
	
		//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	АктПриемкиГабаритныхЧертежейГабаритныеЧертежи.ГабаритныйЧертеж КАК ГабаритныйЧертеж,
		|	АктПриемкиГабаритныхЧертежейГабаритныеЧертежи.ГабаритныйЧертеж.Наименование КАК ГабаритныйЧертежНаименование,
		|	АктПриемкиГабаритныхЧертежейГабаритныеЧертежи.ГабаритныйЧертеж.Проект КАК Проект
		|ИЗ
		|	Документ.АктПриемкиГабаритныхЧертежей.ГабаритныеЧертежи КАК АктПриемкиГабаритныхЧертежейГабаритныеЧертежи
		|ГДЕ
		|	АктПриемкиГабаритныхЧертежейГабаритныеЧертежи.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		СоздатьЗадачуПроверитьГабаритныеЧертежи(ВыборкаДетальныеЗаписи, Исполнитель);
	КонецЦикла;
	
	//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА

	
	

КонецФункции // ПолучитьГЧДляИзменения()

Процедура СоздатьЗадачуПроверитьГабаритныеЧертежи(Выборка, Исполнитель)

	ЗадачаПроверки = Задачи.ПроверитьГабаритныеЧертежи.СоздатьЗадачу();
	ЗадачаПроверки.Дата 					= ТекущаяДата();
	ЗадачаПроверки.Основание 				= Ссылка;
	ЗадачаПроверки.ГабаритныйЧертеж 		= Выборка.ГабаритныйЧертеж;
	ЗадачаПроверки.Исполнитель 				= Исполнитель;
	ЗадачаПроверки.Наименование				= Выборка.ГабаритныйЧертежНаименование + ".Проверка";	
	ЗадачаПроверки.Проект					= Выборка.Проект;	
	ЗадачаПроверки.НовыйСтатус				= НовыйСтатус;	
	ЗадачаПроверки.КрайняяДатаИсполнения	= ЗадачаПроверки.Дата + 7 * 24 * 3600;	
	ЗадачаПроверки.БылаКорректировка		= 0;	
	
	ЗадачаПроверки.Записать();

КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	Если НЕ ЗначениеЗаполнено(Номер) Тогда
		Префикс = Проект.Префикс + "-";
		УстановитьНовыйНомер(Префикс); 
	КонецЕсли;
КонецПроцедуры
 
