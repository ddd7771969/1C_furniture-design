
Функция ПолучитьНаименованиеГЧ(Сделка, ОсновноеПомещение, НаименованиеБезКода, НомерВПомещении) Экспорт 
	
	
	КодСделки 		= "";
	КодПомещения 	= "";
	
	Если ЗначениеЗаполнено(Сделка) Тогда
		КодСделки = Формат(Сделка.Номер, "ЧЦ=2; ЧВН=");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ОсновноеПомещение) Тогда
		КодПомещения = ОсновноеПомещение.НомерПомещения;
	КонецЕсли;

	Возврат Новый Структура("Наименование, ОсновноеПомещение", 
											КодСделки + "." + КодПомещения + ?(НомерВПомещении = 0, "", "-" + НомерВПомещении) + "." + НаименованиеБезКода,
											ОсновноеПомещение);
	
КонецФункции // СформироватьНаименованиеГЧ(ГабаритныйЧертежОбъект)

Функция ПолучитьГабаритныеЧертежиПоПомещениям(МассивПомещений, Сделка = Неопределено) Экспорт

	Если Сделка = Неопределено Тогда
		
		Если МассивПомещений.Количество() = 0 Тогда
			Возврат Новый Массив;
		КонецЕсли;
		
		СделкаПомещений = МассивПомещений[0].Проект;

	Иначе	
		СделкаПомещений = Сделка;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ГабаритныеЧертежиПомещения.Ссылка КАК ГабаритныйЧертеж
		|ПОМЕСТИТЬ вт
		|ИЗ
		|	Справочник.ГабаритныеЧертежи.Помещения КАК ГабаритныеЧертежиПомещения
		|ГДЕ
		|	ГабаритныеЧертежиПомещения.Ссылка.Проект = &Проект
		|	И НЕ ГабаритныеЧертежиПомещения.Помещение В (&МассивПомещений)
		|
		|СГРУППИРОВАТЬ ПО
		|	ГабаритныеЧертежиПомещения.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ГабаритныеЧертежи.Ссылка КАК ГабаритныйЧертеж
		|ИЗ
		|	Справочник.ГабаритныеЧертежи КАК ГабаритныеЧертежи
		|		ЛЕВОЕ СОЕДИНЕНИЕ вт КАК вт
		|		ПО (вт.ГабаритныйЧертеж = ГабаритныеЧертежи.Ссылка)
		|ГДЕ
		|	вт.ГабаритныйЧертеж ЕСТЬ NULL";
	
	Запрос.УстановитьПараметр("МассивПомещений", МассивПомещений);
	Запрос.УстановитьПараметр("Проект", Сделка);
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ГабаритныйЧертеж");
	
КонецФункции // ПолучитьГабаритныеЧертежиПоПомещениям()

Функция ПолучитьРодительГабаритногоЧертежа(Сделка) Экспорт

	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ГабаритныеЧертежи.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.ГабаритныеЧертежи КАК ГабаритныеЧертежи
		|ГДЕ
		|	ГабаритныеЧертежи.Проект = &Проект
		|	И ГабаритныеЧертежи.ЭтоГруппа";
	
	Запрос.УстановитьПараметр("Проект", Сделка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Возврат Выборка.Ссылка;
	КонецЦикла;
	
    Возврат Справочники.ГабаритныеЧертежи.ПустаяСсылка();
	
КонецФункции // ПолучитьРодительКопозиции()

Процедура УстановитьКодПДМДляГабаритныйЧертеж(ПараметрГабаритныйЧертеж, КодВПДМ) Экспорт

	
	Если ТипЗнч(ПараметрГабаритныйЧертеж) = Тип("Строка") Тогда
		ГабаритныйЧертеж = Справочники.ГабаритныеЧертежи.НайтиПоКоду(ПараметрГабаритныйЧертеж);
	Иначе
		ГабаритныйЧертеж = ПараметрГабаритныйЧертеж;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ГабаритныйЧертеж) Тогда
	
		МенеджерЗаписей 					= РегистрыСведений.ДанныеГабаритныйЧертеж.СоздатьМенеджерЗаписи();
		МенеджерЗаписей.ГабаритныйЧертеж 	= ГабаритныйЧертеж;
		
		МенеджерЗаписей.Прочитать();
		
		Если ЗначениеЗаполнено(МенеджерЗаписей.ГабаритныйЧертеж) Тогда
			
			Если НЕ МенеджерЗаписей.Код_в_PDM = КодВПДМ Тогда
				
				МенеджерЗаписей.Код_в_PDM = КодВПДМ;
				МенеджерЗаписей.Записать();
				
			КонецЕсли;
			
		Иначе
			
			МенеджерЗаписей.ГабаритныйЧертеж 	= ГабаритныйЧертеж;
			МенеджерЗаписей.Код_в_PDM 			= КодВПДМ;
			
			МенеджерЗаписей.Записать();
			
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры // УстановитьКодПДМДляСделки()

Функция ПолучитьПлановуюДатуГотовностиГабаритногоЧертежа(ГабаритныйЧертеж) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПлановаяГотовностьГабаритныхЧертежей.ДатаГотовности КАК ДатаГотовности
		|ИЗ
		|	РегистрСведений.ПлановаяГотовностьГабаритныхЧертежей КАК ПлановаяГотовностьГабаритныхЧертежей
		|ГДЕ
		|	ПлановаяГотовностьГабаритныхЧертежей.ГабаритныйЧертеж = &ГабаритныйЧертеж";
	
	Запрос.УстановитьПараметр("ГабаритныйЧертеж", ГабаритныйЧертеж);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Возврат Выборка.ДатаГотовности;	
	КонецЦикла;
	
	Возврат Дата(1, 1, 1);	

КонецФункции // ПолучитьПлановуюДатуГотовностиГабаритногоЧертежа(ГабаритныйЧертеж)

