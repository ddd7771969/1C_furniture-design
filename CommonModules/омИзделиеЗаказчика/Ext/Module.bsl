
&НаСервере
Функция ПолучитьПомещенияИзделияЗаказчика(ИзделиеЗаказчика, МассивПомещений = Неопределено) Экспорт
	МассивПомещений = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ИзделияЗаказчикаИзделияЭлемент.Ссылка КАК ИзделиеЗаказчика,
		|	ИзделияЗаказчикаИзделияЭлемент.ИзделиеЭлемент.Помещения КАК Помещения
		|ИЗ
		|	Справочник.ИзделияЗаказчика.ИзделияЭлемент КАК ИзделияЗаказчикаИзделияЭлемент
		|ГДЕ
		|	ИзделияЗаказчикаИзделияЭлемент.Ссылка В(&Ссылка)
		|
		|СГРУППИРОВАТЬ ПО
		|	ИзделияЗаказчикаИзделияЭлемент.ИзделиеЭлемент.Помещения,
		|	ИзделияЗаказчикаИзделияЭлемент.Ссылка
		|
		|УПОРЯДОЧИТЬ ПО
		|	ИзделияЗаказчикаИзделияЭлемент.ИзделиеЭлемент.Помещения.Наименование";
	
	Запрос.УстановитьПараметр("Ссылка", ИзделиеЗаказчика);
	
	РезультатЗапроса = Запрос.Выполнить(); 
	
	Если ТипЗнч(ИзделиеЗаказчика) = Тип("Массив") Тогда
		тзВозврата = Новый ТаблицаЗначений;
		тзВозврата.Колонки.Добавить("ИзделиеЗаказчика", Новый ОписаниеТипов("СправочникСсылка.ИзделияЗаказчика"));
		тзВозврата.Колонки.Добавить("Помещения", Новый ОписаниеТипов("Строка"));
		

		тзВыгрузка =  РезультатЗапроса.Выгрузить();
		
		мИзделияЗаказчика = Новый Массив;
		Для каждого х Из тзВыгрузка Цикл
			Если мИзделияЗаказчика.Найти(х.ИзделиеЗаказчика) = Неопределено Тогда
				
				мИзделияЗаказчика.Добавить(х.ИзделиеЗаказчика);	
				
			КонецЕсли;	
		КонецЦикла; 
		
		стОтбор = Новый Структура("ИзделиеЗаказчика", ); 
		
		Для каждого ИзделиеЗаказчика Из мИзделияЗаказчика Цикл
			стОтбор.ИзделиеЗаказчика = ИзделиеЗаказчика;
			НайденыеСтроки = тзВыгрузка.НайтиСтроки(стОтбор);
			стрПомещение = "";
			
			Для каждого х Из НайденыеСтроки Цикл
				стрПомещение = омРаботаССтроками.ДобавитьРазделительНеПустойСтроке(стрПомещение) + х.Помещения;
			КонецЦикла;
			
		    НС = тзВозврата.Добавить();
			НС.ИзделиеЗаказчика = ИзделиеЗаказчика;
			НС.Помещения 		= стрПомещение;
		КонецЦикла;
				
		Возврат тзВозврата;
		
		//Возврат ОбщегоНазначения.ТаблицаЗначенийВМассив(тзВозврата);	
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	
	стрВозврата = "";
	
	Пока Выборка.Следующий() Цикл
		стрВозврата = омРаботаССтроками.ДобавитьРазделительНеПустойСтроке(стрВозврата) + Выборка.Помещения;
		ДобавитьПомещениеВМассив(МассивПомещений,Выборка.Помещения);
	КонецЦикла;
	

	Возврат стрВозврата;

КонецФункции // ПолучитьПомещенияИзделияЗаказчика() 

&НаСервере
Процедура ДобавитьПомещениеВМассив(МассивПомещений, Помещение)

	Если МассивПомещений.Найти(Помещение) = Неопределено Тогда
	
		МассивПомещений.Добавить(Помещение);	
	
	КонецЕсли;	
	
КонецПроцедуры // ДобавитьПомещениеВМассив()

