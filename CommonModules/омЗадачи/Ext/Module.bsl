Процедура СоздатьЗадачуНаСозданиеГабаритногоЧеритежа(Проект, ГабаритныйЧертеж, КрайняяДатаИсполнения = Неопределено) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СоздатьМодельГабаритногоЧертежа.Ссылка КАК СоздатьМодельГабаритногоЧертежа
		|ИЗ
		|	Задача.СоздатьМодельГабаритногоЧертежа КАК СоздатьМодельГабаритногоЧертежа
		|ГДЕ
		|	СоздатьМодельГабаритногоЧертежа.ГабаритныйЧертеж = &ГабаритныйЧертеж";
	
	Запрос.УстановитьПараметр("ГабаритныйЧертеж", ГабаритныйЧертеж);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл

		Если ЗначениеЗаполнено(Выборка.СоздатьМодельГабаритногоЧертежа) Тогда
			Возврат;
		КонецЕсли;
		
	КонецЦикла;
	
	Исполнитель = Справочники.НазначениеАвтораДляЗадачи.ПолучитьАвтораДляЗадачи(Проект, Перечисления.ОбъектыЗадач.ПроверятьГабаритныеЧерчежи);
	
	НоваяЗадача 						= Задачи.СоздатьМодельГабаритногоЧертежа.СоздатьЗадачу();
	НоваяЗадача.ГабаритныйЧертеж 		= ГабаритныйЧертеж;
	НоваяЗадача.Дата 					= ТекущаяДата();
	НоваяЗадача.Исполнитель 			= Исполнитель;
	НоваяЗадача.Проект 					= ГабаритныйЧертеж.Проект;
	НоваяЗадача.КрайняяДатаИсполнения 	= КрайняяДатаИсполнения;
	НоваяЗадача.Наименование 			= Строка(ГабаритныйЧертеж) + ".Создание";
	
	НоваяЗадача.Записать();
	
КонецПроцедуры


Функция ПолучитьИсполнителя(ОбъектЗадачи = Неопределено, ТолькоПервый = Истина) Экспорт
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	НазначениеАвтораДляЗадачи.Исполнитель КАК Исполнитель,
		|	НазначениеАвтораДляЗадачи.ОбъектЗадачи КАК ОбъектЗадачи
		|ИЗ
		|	Справочник.НазначениеАвтораДляЗадачи КАК НазначениеАвтораДляЗадачи
		|ГДЕ
		|	ВЫБОР
		|			КОГДА НазначениеАвтораДляЗадачи.ОбъектЗадачи = НЕОПРЕДЕЛЕНО
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ НазначениеАвтораДляЗадачи.ОбъектЗадачи = &ОбъектЗадачи
		|		КОНЕЦ
		|	И НЕ НазначениеАвтораДляЗадачи.ПометкаУдаления
		|
		|УПОРЯДОЧИТЬ ПО
		|	НазначениеАвтораДляЗадачи.ОбъектЗадачи,
		|	НазначениеАвтораДляЗадачи.Сортировка";
	
	Запрос.УстановитьПараметр("ОбъектЗадачи", ОбъектЗадачи);
	
	
	Если ТолькоПервый ИЛИ НЕ ОбъектЗадачи = Неопределено Тогда
		              
		мИсполнители = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Исполнитель");
		
		Если ТолькоПервый Тогда
			Если мИсполнители.Количество() = 0 Тогда
			
				Возврат Справочники.Пользователи.ПустаяСсылка();	
			
			Иначе
			
				Возврат мИсполнители[0];	
			
			КонецЕсли;
		
		Иначе
		
			Возврат мИсполнители;	
		
		КонецЕсли;
	
	Иначе 
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		соИсполнители = Новый Соответствие;
		
		текОбъектЗадачи = Неопределено;
		мИсполнители 	= Неопределено;
		
		Пока Выборка.Следующий() Цикл
			
			Если НЕ текОбъектЗадачи = Выборка.ОбъектЗадачи Тогда
				
				Если НЕ текОбъектЗадачи = Неопределено Тогда
					соИсполнители.Вставить(текОбъектЗадачи, мИсполнители);	
				КонецЕсли;	
				
			    мИсполнители = Новый Массив;
			КонецЕсли;
			
			мИсполнители.Добавить(Выборка.Исполнитель);
			
		КонецЦикла;
		
		Если НЕ текОбъектЗадачи = Неопределено Тогда
			соИсполнители.Вставить(текОбъектЗадачи, мИсполнители);	
		КонецЕсли;	
		
		Возврат соИсполнители;
		
	КонецЕсли;
	
КонецФункции // ПолучитьИсполнителя()
