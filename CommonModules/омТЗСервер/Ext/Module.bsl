

&НаСервере
Функция ПолучитьАдресВременногоХранилища(ОбъектТЗ, Версия, ИмяФайла, УникальныйИдентификатор) Экспорт

	Выборка = ПолучитьДанныеОФайле(ОбъектТЗ, Версия);
	
	Пока Выборка.Следующий() Цикл
		ИмяФайла = Выборка.ИмяФайла;
		ПолноеИмяФайла = КаталогВременныхФайлов()  + ИмяФайла + ".pdf";
		
		ДвоичныеДанные = Выборка.ФайлТЗ.Получить();
		
		Если ДвоичныеДанные = Неопределено Тогда
			Возврат "";
		КонецЕсли;
		
		ДвоичныеДанные.Записать(ПолноеИмяФайла);
		
		Двоичное = Новый ДвоичныеДанные(ПолноеИмяФайла);  // получаем двоичные данные из файла
		Адрес = ПоместитьВоВременноеХранилище(Двоичное, УникальныйИдентификатор); // кидаем двоичные данные во врем. хранилище
		
		УдалитьФайлы(ПолноеИмяФайла);
		
		Возврат Адрес;
	КонецЦикла;
	
	Возврат "";

КонецФункции // ПолучитьАдресВременногоХранилища() 

&НаСервере
Функция ПолучитьДанныеОФайле(ОбъектТЗ, Версия)
	
	Запрос = Новый Запрос;
	Если Версия < 0 Тогда
		
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	МАКСИМУМ(ТЗ_Изделий.Версия) КАК Версия
			|ПОМЕСТИТЬ вт
			|ИЗ
			|	РегистрСведений.ТЗ_Изделий КАК ТЗ_Изделий
			|ГДЕ
			|	ТЗ_Изделий.ОбъектТЗ = &ОбъектТЗ
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ТЗ_Изделий.ИмяФайла КАК ИмяФайла,
			|	ТЗ_Изделий.ФайлТЗ КАК ФайлТЗ
			|ИЗ
			|	РегистрСведений.ТЗ_Изделий КАК ТЗ_Изделий
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ вт КАК вт
			|		ПО ТЗ_Изделий.Версия = вт.Версия
			|ГДЕ
			|	ТЗ_Изделий.ОбъектТЗ = &ОбъектТЗ";
		
	Иначе
		
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	ТЗ_Изделий.ИмяФайла КАК ИмяФайла,
			|	ТЗ_Изделий.ФайлТЗ КАК ФайлТЗ
			|ИЗ
			|	РегистрСведений.ТЗ_Изделий КАК ТЗ_Изделий
			|ГДЕ
			|	ТЗ_Изделий.ОбъектТЗ = &ОбъектТЗ
			|	И ТЗ_Изделий.Версия = &Версия";
		
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Версия", Версия);
	Запрос.УстановитьПараметр("ОбъектТЗ", ОбъектТЗ);
	
	РезультатЗапроса = Запрос.Выполнить().Выбрать();
	
	Выборка = РезультатЗапроса;
	
	Возврат Выборка;
	
КонецФункции // ПолучитьДанныеОФайле(ОбъектТЗ, Версия)

