
&НаКлиенте
Процедура ПроектПриИзменении(Элемент)
	СформироватьОтчетНаСервере();
КонецПроцедуры 

&НаКлиенте
Процедура Обновить(Команда)
	СформироватьОтчетНаСервере();
КонецПроцедуры

Процедура СформироватьОтчетНаСервере()
	
	ПолеВывода.Очистить();
	
	Если Не ЗначениеЗаполнено(Проект) Тогда
		Возврат;	
	КонецЕсли;
	
	
	стТаблицы 	= ПолучитьТаблицуДанных();
	
	ВывестиДанные(стТаблицы);
КонецПроцедуры // СформироватьОтчетНаСервере()


Функция ПолучитьТаблицуДанных()

	тзДанные 	= ЗаполнитьКомплектыИзделий();
	
	РассчитатьПоля(тзДанные);
	
	Возврат Новый Структура("тзДанные", тзДанные);
	
КонецФункции // ПолучитьТаблицуДанных() 

Процедура РассчитатьПоля(тзДанные)                                   

	

КонецПроцедуры


Функция ЗаполнитьКомплектыИзделий()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ИзделияКомплект.Ссылка КАК ИзделиеКомплект,
		|	ВЫБОР
		|		КОГДА ИзделияКомплект.Родитель.Композиция ЕСТЬ NULL
		|			ТОГДА """"
		|		ИНАЧЕ ИзделияКомплект.Родитель.Композиция.Наименование
		|	КОНЕЦ КАК КомпозицииНаименование,
		|	ВЫБОР
		|		КОГДА ИзделияКомплект.Родитель.Композиция ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.Композиции.ПустаяСсылка)
		|		ИНАЧЕ ИзделияКомплект.Родитель.Композиция
		|	КОНЕЦ КАК Композиция,
		|	ИзделияКомплект.Наименование КАК КомплектНаименование
		|ИЗ
		|	Справочник.ИзделияКомплект КАК ИзделияКомплект
		|ГДЕ
		|	ИзделияКомплект.Проект = &Проект
		|
		|УПОРЯДОЧИТЬ ПО
		|	КомпозицииНаименование,
		|	КомплектНаименование";
	
	Запрос.УстановитьПараметр("Проект", Проект);
	
	Возврат Запрос.Выполнить().Выгрузить();
	

КонецФункции // ЗаполнитьКомплектыИзделий()

Процедура ВывестиДанные(стТаблицы)

	
	ПустаяДата = Дата(1,1,1);
	
	Таб = ПолеВывода;
	Таб.Очистить();
	
	Макет = Отчеты.СостояниеПроекта.ПолучитьМакет("Макет");
	
	Таб.Вывести(Макет.ПолучитьОбласть("Шапка"));
	Таб.ФиксацияСверху = Таб.ВысотаТаблицы;
	
    обСтрока 	= Макет.ПолучитьОбласть("Строка"); 
	
	Согласование 	= "";
	Утверждение 	= "";
	
	Для каждого текСтрока Из стТаблицы.тзДанные Цикл
		обСтрока.Параметры.Заполнить(текСтрока); 
		
		Таб.Вывести(обСтрока);
	КонецЦикла; 
	
	Таб.Вывести(Макет.ПолучитьОбласть("ПоследняяСтрока"));
КонецПроцедуры // ВывестиДанные()
