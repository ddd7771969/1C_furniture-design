
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
		
	мНастройкиСинхронизации = Б24_К_ОбщегоНазначенияВызовСервераПовтИсп.ПолучитьМассивНастроекПодключения();
	Для Каждого Выборка Из мНастройкиСинхронизации Цикл	
		
		Если НЕ ЗначениеЗаполнено(Выборка.Портал) Тогда
			Продолжить;
		КонецЕсли;
		
		Если Элементы.Портал.СписокВыбора.НайтиПоЗначению(Выборка.Портал) = Неопределено Тогда
			Элементы.Портал.СписокВыбора.Добавить(Выборка.Портал);
		КонецЕсли;
		
	КонецЦикла;

КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
		
	ТипыДанныхДляОбменаСПорталом = Б24_К_ОбщегоНазначенияВызовСервера.ПолучитьТипыДанныхДляОбменаСПорталом();
	
	Если Запись.ТипДанных = ТипыДанныхДляОбменаСПорталом.ГруппаТовара ИЛИ Запись.ТипДанных = ТипыДанныхДляОбменаСПорталом.ГруппаТовара2 Тогда
		Элементы.Объект.ВыборГруппИЭлементов = ГруппыИЭлементы.Группы;
	Иначе
		Элементы.Объект.ВыборГруппИЭлементов = ГруппыИЭлементы.Элементы;
	КонецЕсли;

	Если Запись.ТипДанных = ТипыДанныхДляОбменаСПорталом.СвойствоЗаказа Тогда
		Элементы.КомандаЗагрузитьИдПлательщиков.Видимость 	= Истина;
		Элементы.ПодчиненныйОбъект.КнопкаВыбора 			= Ложь;	
	Иначе
		Элементы.КомандаЗагрузитьИдПлательщиков.Видимость 	= Ложь;
		Элементы.ПодчиненныйОбъект.КнопкаВыпадающегоСписка 	= Ложь;	
		Элементы.ПодчиненныйОбъект.КнопкаВыбора 			= Истина;	
	КонецЕсли;
		
КонецПроцедуры

#КонецОбласти


#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура КомандаЗагрузитьИдПлательщиков(Команда)
	
	КоличествоНастроек = Б24_К_ОбщегоНазначенияВызовСервераПовтИсп.ПолучитьКоличествоНастроекПодключения();
	
	Если КоличествоНастроек > 1 Тогда
		
		ВыбЗнач 	= Неопределено;
		
		Массив 		= Новый Массив;
		Массив.Добавить(Тип("СправочникСсылка.Б24_К_НастройкиПодключения"));
		ОписаниеТипов = Новый ОписаниеТипов(Массив);
		
		Оповещение = Новый ОписаниеОповещения("ПослеВводаЗначения", ЭтотОбъект);

		ПоказатьВводЗначения(Оповещение, ВыбЗнач, "Укажите настройку подключения", ОписаниеТипов);	
		
	Иначе
		ПараметрыДиалога = Новый Структура;	
		ПослеВводаЗначения(Б24_К_ОбщегоНазначенияВызовСервераПовтИсп.ПолучитьНастройкуПодключенияПоУмолчанию(), ПараметрыДиалога);	
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеВводаЗначения(ВыбЗнач, Параметры) Экспорт
	
	Если ЗначениеЗаполнено(ВыбЗнач) Тогда

		НастройкаПодключения = ВыбЗнач; 

		Элементы.ПодчиненныйОбъект.СписокВыбора.Очистить();
		
		СтруктураНастроек =  Б24_К_ОбщегоНазначенияВызовСервера.СформироватьСтруктуруНастроек(НастройкаПодключения);  
		СтруктураНастроек = Неопределено;
		Если СтруктураНастроек = Неопределено Тогда
			ПоказатьПредупреждение(, "Не удалось подключиться к Битрикс24");
			Возврат;
		КонецЕсли;
		
		СтруктураНастроек.Логирование.Измерение1 = "Ручное получение данных";	
		СтруктураНастроек.Логирование.Измерение2 = "Получение плательщиков заказов";	
		
		Метод = "/rest/sale.persontype.list";
		
		Фильтр = "&filter[>ID]=0";
		
		СтруктураОтвета = Б24_К_RestApiВызовСервера.ОтправкаДанныхНаПортал(СтруктураНастроек, Метод, Фильтр); 
		
		Если СтруктураОтвета = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		Если СтруктураОтвета.Получить("result") <> неопределено Тогда
			
			Для каждого ТекЭлемент Из СтруктураОтвета.Получить("result") Цикл
				
				Если ТекЭлемент.Получить("active") <> "Y" Тогда
					Продолжить;
				КонецЕсли;
				
				Элементы.ПодчиненныйОбъект.СписокВыбора.Добавить(Формат(ТекЭлемент.Получить("id"), "ЧГ=0"), ТекЭлемент.Получить("name"));
				
			КонецЦикла;
		
		КонецЕсли;
		
		Следующие = СтруктураОтвета.Получить("next"); 
		
		Пока ЗначениеЗаполнено(Следующие) Цикл
			
			Следующие = Формат(Следующие, "ЧГ=0");

			ТелоHTTPЗапроса = "&start="+Следующие + Фильтр;	
			
			СтруктураОтвета = Б24_К_RestApiВызовСервера.ОтправкаДанныхНаПортал(СтруктураНастроек, Метод, ТелоHTTPЗапроса); 
			
			Если СтруктураОтвета = Неопределено Тогда
				Прервать;
			КонецЕсли;
			
			Если СтруктураОтвета.Получить("result") <> Неопределено Тогда
				
				Для каждого ТекЭлемент Из СтруктураОтвета.Получить("result") Цикл
					
					Если ТекЭлемент.Получить("active") <> Истина Тогда
						Продолжить;
					КонецЕсли;
					
					Элементы.ПодчиненныйОбъект.СписокВыбора.Добавить(Формат(ТекЭлемент.Получить("id"), "ЧГ=0"), ТекЭлемент.Получить("name"));
					
				КонецЦикла;
			КонецЕсли;
			
		   Следующие = СтруктураОтвета.Получить("next");
		   
		КонецЦикла;
		
	КонецЕсли;
	
	Элементы.ПодчиненныйОбъект.КнопкаВыпадающегоСписка = Истина;	
	
КонецПроцедуры

#КонецОбласти


#Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура ТипДанныхПриИзменении(Элемент)
	
	ТипыДанныхДляОбменаСПорталом = Б24_К_ОбщегоНазначенияВызовСервера.ПолучитьТипыДанныхДляОбменаСПорталом();
	
	Если Запись.ТипДанных = ТипыДанныхДляОбменаСПорталом.ГруппаТовара ИЛИ Запись.ТипДанных = ТипыДанныхДляОбменаСПорталом.ГруппаТовара2 Тогда
		Элементы.Объект.ВыборГруппИЭлементов = ГруппыИЭлементы.Группы;
	Иначе
		Элементы.Объект.ВыборГруппИЭлементов = ГруппыИЭлементы.Элементы;
	КонецЕсли;

	Если Запись.ТипДанных = ТипыДанныхДляОбменаСПорталом.СвойствоЗаказа Тогда
		Элементы.КомандаЗагрузитьИдПлательщиков.Видимость 	= Истина;
		Элементы.ПодчиненныйОбъект.КнопкаВыбора 			= Ложь;	
	Иначе
		Элементы.КомандаЗагрузитьИдПлательщиков.Видимость 	= Ложь;
		Элементы.ПодчиненныйОбъект.КнопкаВыпадающегоСписка 	= Ложь;	
		Элементы.ПодчиненныйОбъект.КнопкаВыбора 			= Истина;	
	КонецЕсли;
		
КонецПроцедуры

#КонецОбласти





